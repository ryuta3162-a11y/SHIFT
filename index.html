<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>経堂シフト閲覧ポータル | Kyodo Shift Dashboard</title>
  <!-- 外部ライブラリ (CDN) -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&display=swap');
    
    body { 
      font-family: 'Noto Sans JP', sans-serif; 
      background-color: #ffffff; 
      color: #1e293b;
      margin: 0;
      padding: 0;
    }

    /* A4横 印刷最適化スタイル */
    @media print {
      @page { size: A4 landscape; margin: 6mm; }
      body { background-color: white; }
      .no-print { display: none !important; }
      .print-container { padding: 0 !important; width: 100% !important; max-width: none !important; }
      .table-wrapper { border: 1.5px solid #cbd5e1 !important; border-radius: 0 !important; overflow: visible !important; }
      th, td { border: 1px solid #cbd5e1 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    }

    .empty-corner { background-color: white !important; border: none !important; }
    .header-date { background-color: white; color: #1e293b; font-weight: 800; border-bottom: 2px solid #e2e8f0; height: 40px; }
    .header-dow { background-color: #f8fafc; color: #64748b; font-size: 0.75rem; font-weight: 900; height: 25px; }
    
    /* スタッフ名セル: 中央揃え・外枠強調（経堂レッド） */
    .name-cell { 
      position: sticky; 
      left: 0; 
      background-color: #ffffff !important; 
      z-index: 20; 
      border: 3.5px solid #C21642 !important; 
      min-width: 140px; 
      font-size: 1.35rem;
      font-weight: 900;
      text-align: center !important; 
      vertical-align: middle !important;
      color: #1e293b;
      box-shadow: 2px 0 5px rgba(0,0,0,0.04);
    }
    
    /* 3Dバッジ: 勤務時間の立体感デザイン */
    .time-badge { 
      display: inline-block;
      background: linear-gradient(135deg, #ffffff 0%, #f1f5f9 100%);
      color: #C21642; 
      padding: 4px 8px; 
      border-radius: 6px; 
      border: 1px solid #e2e8f0; 
      font-size: 0.88rem;
      font-weight: 900;
      box-shadow: 2px 2px 5px rgba(0,0,0,0.07), inset -1px -1px 2px rgba(255,255,255,0.8);
      line-height: 1;
      letter-spacing: -0.02em;
    }

    /* 備考テキストのデザイン */
    .memo-text {
      font-size: 0.65rem;
      color: #475569;
      line-height: 1.1;
      font-weight: 600;
      display: block;
      padding: 0 4px;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
    }

    /* 公休と有給の装飾 */
    .holiday-x { color: #dc2626; font-size: 1.6rem; font-weight: 900; }
    .paid-leave { color: #059669; font-weight: 900; font-size: 0.95rem; }
    
    /* セル高さ調整 */
    .shift-cell { min-width: 50px; height: 38px; border-bottom: none !important; }
    .memo-cell { min-width: 50px; height: 26px; vertical-align: top !important; border-top: none !important; }
    
    /* 土日カラー */
    .text-sun { color: #dc2626 !important; }
    .text-sat { color: #2563eb !important; }
    .bg-sun { background-color: #fff1f2 !important; }
    .bg-sat { background-color: #eff6ff !important; }

    .table-title {
      font-size: 1.4rem;
      font-weight: 900;
      color: #C21642;
      padding: 10px 24px;
      background-color: #fdf2f2;
      border-left: 8px solid #C21642;
      margin-bottom: 20px;
      display: inline-block;
      border-radius: 0 12px 12px 0;
    }

    .tier-container { margin-bottom: 50px; page-break-inside: avoid; width: 100%; }
    .stats-cell { border-left: 2px solid #e2e8f0 !important; background-color: #f8fafc !important; font-weight: 900; }
    
    /* ローディングアニメーション */
    .loader {
      border: 4px solid #f3f3f3; border-top: 4px solid #C21642; border-radius: 50%;
      width: 35px; height: 35px; animation: spin 1s linear infinite; display: inline-block;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, Fragment } = React;

    const CONFIG = {
      // 提供されたGASのデプロイURLをここに反映済み
      GAS_API_URL: "https://script.google.com/macros/s/AKfycbyLLX4EzfuvswXUgFwL19U8ZeZcuQ4pr287p-etGdEwG3Ej6kFMCAqkqR2hlr1FvaEo/exec" 
    };

    function App() {
      const [data, setData] = useState(null);
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);

      useEffect(() => {
        const fetchData = async () => {
          try {
            const res = await fetch(CONFIG.GAS_API_URL);
            const json = await res.json();
            if (json.error) throw new Error(json.error);
            setData(json);
          } catch (err) {
            setError(err.message || "スプレッドシートとの通信に失敗しました。");
          } finally {
            setLoading(false);
          }
        };
        fetchData();
      }, []);

      if (loading) return (
        <div className="min-h-screen flex flex-col items-center justify-center space-y-6">
          <div className="loader"></div>
          <p className="font-black text-[#C21642] animate-pulse uppercase tracking-[0.2em] text-sm">Kyodo Shift Portal Loading...</p>
        </div>
      );

      if (error) return (
        <div className="min-h-screen flex items-center justify-center p-10">
          <div className="bg-red-50 border-4 border-red-100 p-10 rounded-[2.5rem] text-center max-w-xl shadow-2xl">
            <h2 className="text-3xl font-black text-red-600 mb-4 tracking-tighter">CONNECTION ERROR</h2>
            <p className="text-red-500 font-bold mb-8 leading-relaxed">{error}</p>
            <button onClick={() => window.location.reload()} className="px-12 py-4 bg-red-600 text-white rounded-2xl font-black hover:bg-red-700 shadow-xl">再試行する</button>
          </div>
        </div>
      );

      return (
        <div className="p-4 md:p-10 print:p-0">
          <div className="max-w-full mx-auto">
            <header className="flex justify-between items-end mb-12 no-print border-b-4 border-gray-100 pb-8">
              <div>
                <h1 className="text-5xl font-black text-gray-900 tracking-tighter mb-2">{data.month}</h1>
                <p className="text-gray-400 font-bold uppercase tracking-[0.3em] text-xs">Management System v2.0</p>
              </div>
              <button 
                onClick={() => window.print()} 
                className="px-12 py-5 bg-gray-900 text-white rounded-[1.25rem] font-black shadow-2xl hover:bg-black transition-all hover:scale-105 active:scale-95 flex items-center gap-3"
              >
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="M6 9V2h12v7"></path><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>
                A4横印刷 実行
              </button>
            </header>

            <main>
              <ShiftTierTable data={data} start={0} end={15} label="上旬 (1日〜15日)" />
              <div className="h-14 print:h-8" />
              <ShiftTierTable data={data} start={15} end={data.dates.length} label="下旬 (16日〜末日)" showStats={true} />
            </main>
          </div>
        </div>
      );
    }

    function ShiftTierTable({ data, start, end, label, showStats = false }) {
      const datesInRange = data.dates.slice(start, end);
      const dowsInRange = data.dows.slice(start, end);

      return (
        <div className="tier-container">
          <div className="table-title no-print">{label}</div>
          <div className="table-wrapper border border-gray-200 rounded-[2rem] overflow-hidden shadow-lg">
            <table className="w-full border-collapse bg-white table-fixed">
              <thead>
                <tr className="header-date">
                  <th className="empty-corner w-[140px] sticky left-0 z-30 border-r-[3.5px] border-[#C21642]"></th>
                  {datesInRange.map((d, i) => (
                    <th key={i} className="text-[0.7rem] font-black text-gray-400 border-l border-gray-50 uppercase tracking-tighter">{d}</th>
                  ))}
                  {showStats && <th colSpan={3} className="bg-gray-800 text-white text-[10px] font-black tracking-[0.2em] uppercase">Total Stats</th>}
                </tr>
                <tr className="header-dow">
                  <td className="empty-corner sticky left-0 z-30 border-r-[3.5px] border-[#C21642]"></td>
                  {dowsInRange.map((dw, i) => {
                    const cls = dw === '日' ? 'text-sun bg-red-50/50' : dw === '土' ? 'text-sat bg-blue-50/50' : 'text-gray-600';
                    return <td key={i} className={`text-[11px] font-black border-l border-gray-100 ${cls}`}>{dw}</td>;
                  })}
                  {showStats && (
                    <Fragment>
                      <td className="bg-gray-100 text-[9px] font-bold text-gray-400 border-l border-gray-200 stats-cell text-center">時間</td>
                      <td className="bg-gray-100 text-[9px] font-bold text-gray-400 border-l border-gray-100 stats-cell text-center">公休</td>
                      <td className="bg-gray-100 text-[9px] font-bold text-gray-400 border-l border-gray-100 stats-cell text-center">有給</td>
                    </Fragment>
                  )}
                </tr>
              </thead>
              <tbody className="divide-y divide-gray-100">
                {data.staffs.map((staff, sIdx) => {
                  const isMito = staff.name.includes("みと");
                  return (
                    <Fragment key={sIdx}>
                      <tr>
                        <td rowSpan={2} className="name-cell px-4 py-3">{staff.name}</td>
                        {datesInRange.map((_, i) => {
                          const s = staff.shifts[start + i];
                          const dw = dowsInRange[i];
                          let content = s;
                          if (s === '×' || s === '公休') content = <span className="holiday-x">×</span>;
                          else if (s === '有給') content = <span className="paid-leave">有給</span>;
                          else if (s && /\d/.test(s)) content = <div className="time-badge">{s}</div>;
                          
                          return (
                            <td key={i} className={`shift-cell border-l border-gray-50 ${dw === '日' ? 'bg-red-50/20' : dw === '土' ? 'bg-blue-50/20' : ''} align-middle text-center`}>
                              {content}
                            </td>
                          );
                        })}
                        {showStats && (
                          <Fragment>
                            <td rowSpan={2} className="bg-slate-50 border-l border-gray-200 font-black text-sm align-middle stats-cell text-center">
                              {(isMito && parseFloat(staff.total) === 0) ? "" : `${staff.total}h`}
                            </td>
                            <td rowSpan={2} className="bg-slate-50 border-l border-gray-100 font-black text-red-600 text-xl align-middle stats-cell tracking-tighter text-center">
                              {(isMito && staff.holidays === 0) ? "" : staff.holidays}
                            </td>
                            <td rowSpan={2} className="bg-slate-50 border-l border-gray-100 font-black text-emerald-600 text-xl align-middle stats-cell tracking-tighter text-center">
                              {(isMito && staff.paidLeave === 0) ? "" : staff.paidLeave}
                            </td>
                          </Fragment>
                        )}
                      </tr>
                      <tr>
                        {datesInRange.map((_, i) => {
                          const m = staff.memos[start + i];
                          const dw = dowsInRange[i];
                          return (
                            <td key={i} className={`memo-cell border-l border-gray-50 ${dw === '日' ? 'bg-red-50/20' : dw === '土' ? 'bg-blue-50/20' : ''} align-top px-1 pt-0.5 text-center`}>
                              <span className="memo-text">{m}</span>
                            </td>
                          );
                        })}
                      </tr>
                    </Fragment>
                  );
                })}
              </tbody>
            </table>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>